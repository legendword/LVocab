<!DOCTYPE html>
<html>

<head>
    <title>LVocab - Your Personal Vocabulary List</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="bootstrap-4.2.1/css/bootstrap.min.css" />
    <script src="jquery-1.11.3.js"></script>
    <script src="popper.min.js"></script>
    <script src="bootstrap-4.2.1/js/bootstrap.min.js"></script>
    <script src="PapaParse-4.6.0/papaparse.min.js"></script>
    <script src="ElGen.js"></script>
    <style>
        .space {
        margin-bottom: 30px;
    }

    .sidebar {
        padding: 64px 20px 0;
        font-weight: 500;
        height: 100vh;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    }

    .nav-link {
        color: #333;
    }

    .nav-link.active, .nav-link.active:hover {
        color: #007bff;
    }

    .nav-link:hover {
        color: inherit;
    }

    .mainMain {
        padding: 80px 0 0;
    }

    .tableSearch {
        margin-bottom: 20px;
    }

    tr {
        word-break: break-word;
    }

    .toast {
        background-color: #fff !important;
    }
    </style>
    <script>
        //var baseURL = "http://legendword.com/lvocab/";
        var baseURL = "",
            user = "test",
            dbList = [],
            dbLoaded = false,
            db = {},
            listTemplate =  {
                node: "a",
                attr: {
                    class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
                    id: "list-$id$-list",
                    "data-toggle": "list",
                    href: "#list-$id$",
                    role: "tab"
                },
                html: "$name$ ",
                children: [{
                    node: "span",
                    attr: {
                        class: "badge badge-pill badge-secondary",
                        id: "badge-list-$id$"
                    },
                    html: "$count$"
                }]
            },
            listContentTemplate = {
                node: "div",
                attr: {
                    class: "listContent tab-pane fade",
                    id: "list-$id$",
                    "aria-labelledby": "list-$id$-list",
                    role: "tabpanel"
                },
                children: [
                {
                    node: "div",
                    attr: {
                        class: "tableSearch"
                    },
                    children: [{
                        node: "input",
                        attr: {
                            class: "form-control mr-sm-2",
                            type: "search",
                            placeholder: "Search...",
                            id: "search-$id$",
                            onkeyup: "searchKeydown($id$)"
                        }
                    }]
                },
                {
                    node: "table",
                    attr: {
                        class: "table table-stripped table-hover table-bordered"
                    },
                    children: [{
                        node: "thead",
                        attr: {
                            class: "thead-light"
                        },
                        children: [{
                            node: "tr",
                            children: [
                            {
                                node: "th",
                                attr: {
                                    scope: "col",
                                    style: "width: 15%;"
                                },
                                html: "#"
                            },
                            {
                                node: "th",
                                attr: {
                                    scope: "col",
                                    style: "width: 20%;"
                                },
                                html: "Word"
                            },
                            {
                                node: "th",
                                attr: {
                                    scope: "col",
                                    style: "width: 30%;"
                                },
                                html: "Meaning"
                            },
                            {
                                node: "th",
                                attr: {
                                    scope: "col",
                                    style: "width: 20%;"
                                },
                                html: "Translation"
                            },
                            {
                                node: "th",
                                attr: {
                                    scope: "col",
                                    style: "width: 15%;"
                                },
                                html: "Actions"
                            }]
                        }]
                    },
                    {
                        node: "tbody",
                        attr: {
                            id: "tbody-$id$"
                        }
                    }]
                }]
            },
            tableContentTemplate = {
                node: "tr",
                attr: {
                    class: "tableRow-$listId$",
                    id: "tableRow-$listId$-$id$"
                },
                children: [
                {
                    node: "th",
                    attr: {
                        scope: "row"
                    },
                    html: "$id$"
                },
                {
                    node: "td",
                    html: "$wd$"
                },
                {
                    node: "td",
                    html: "$mn$"
                },
                {
                    node: "td",
                    html: "$ts$"
                },
                {
                    node: "td",
                    children: [{
                        node: "button",
                        attr: {
                            class: "btn btn-secondary btn-sm dropdown-toggle",
                            type: "button",
                            id: "dropdown-$id$",
                            "data-toggle": "dropdown",
                            "aria-haspopup": "true",
                            "aria-expanded": "false"
                        },
                        html: ""
                    },
                    {
                        node: "div",
                        attr: {
                            class: "dropdown-menu",
                            "aria-labelledby": "dropdown-$id$"
                        },
                        children: [{
                            node: "a",
                            attr: {
                                class: "dropdown-item",
                                href: "#",
                                onclick: "dropdownClick($listId$,$id$,'delete')"
                            },
                            html: "Delete"
                        }]
                    }]
                }]
            },
            listSelectTemplate = {
                node: "option",
                attr: {
                    value: "$id$"
                },
                html: "$name$"
            };
        var temp = {
            list: "1",
            optionSelected: "1"
        };
        var limits = {
            word: 100,
            meaning: 3000,
            translation: 100,
            exceedMessage: "One of your fields has exceeded the limit! We encourage words that are within 100 characters, meanings that are within 3000 characters, and translations that are within 100 characters."
        }
            /*
            <option value="1" selected>default</option>
            */
        var loadDB = function(){
            $.post(baseURL+"load.php",{},function(t){
                //console.log(Papa.parse(t,{delimiter: "#"}));
                dbList = Papa.parse(t,{delimiter: "#"}).data;
                dbList.pop(); //last line is empty
                dbLoaded = true;
                listGen();
            });
        };
        var listGen = function(){
            var activeList = $(".listContent.active")[0];
            if (activeList!=null){
                temp.list = activeList.id.slice(5,activeList.id.length);
            }
            $("#list-tab,#nav-tabContent,#fm-lt").html("");
            var di = 1;
            for (var i of dbList) {
                document.getElementById("list-tab").appendChild(ElGen.run(listTemplate,{id: di, name: i[0], count: i[1]}));
                document.getElementById("nav-tabContent").appendChild(ElGen.run(listContentTemplate,{id: di}));
                document.getElementById("fm-lt").appendChild(ElGen.run(listSelectTemplate,{id: di,name: i[0]}));
                di++;
            }
            if (document.querySelector("#fm-lt>option[value='"+temp.optionSelected+"']")!=null) {
                document.querySelector("#fm-lt>option[value='"+temp.optionSelected+"']").setAttribute("selected","true");
            }
            //document.getElementById("list-1-list").setAttribute("class")
            loadAllLists();
        };
        var loadAllLists = function() {
            var di = 1;
            for (var i of dbList) {
                loadList(di, i[0]);
                di++;
            }
            //select most recent list
            $("#list-"+temp.list+"-list").attr("class", $("#list-"+temp.list+"-list").attr("class")+" show active");
            $("#list-"+temp.list).attr("class", $("#list-"+temp.list).attr("class")+" show active");
        };
        var loadList = function(listId, listName) {
            $.post(baseURL+"list.php",{list:listName},function(t){
                if (t=="no such list"||t=="missing"||t=="wrong method") return;
                var ld = Papa.parse(t, {delimiter: "#"}).data;
                ld.pop();
                //console.log(ld);
                $("#tbody-"+listId).html("");
                db[listName] = ld;
                var di = 1;
                for (var i of ld) {
                    document.getElementById("tbody-"+listId).appendChild(ElGen.run(tableContentTemplate,{id: di, wd: i[0], mn: processHidden(i[1],1), ts: processHidden(i[2],2), listId: listId}, {strictReplace: true}));
                    di++;
                }
            });
        };
        var processHidden = function(td, ti) {
            //if (localStorage(""))
            return td;
        };
        var dropdownClick = function(lid, id, act) {
            $.post("action.php",{list:getListName(lid), id:id, action:act},function(t){
                switch (t) {
                    case "success":
                        di = 4;
                        loadDB();
                        break;
                    default:
                        di = 0;
                        break;
                }
                showToast(di,(di==0?t:""));
            })
        };
        var getListName = function(nt) {
            return dbList[parseInt(nt)-1][0];
        };
        var searchKeydown = function(lt,sc) {
            var inp = $("#search-"+lt).val();
            console.log(inp);
            if (inp=="") {
                $(".tableRow-"+lt).show();
                return;
            }
            else {
                $(".tableRow-"+lt).hide();
            }
            var di = 1;
            for (var lf of db[getListName(lt)]) {
                if (lf[0].search(inp)!=-1) {
                    $("#tableRow-"+lt+"-"+di).show();
                }
                di++;
            }
        };
        var openModal = function(mi) {
            $("#modal"+mi).modal();
        };
        var createNewList = function() {
            var name = $("#nl-name").val();
            $("#modal1").modal("hide");
            if (name=="") {
                return;
            }
            $.post("newList.php",{name:name},function(t){
                if (t=="success") {
                    showToast(6,"");
                    loadDB();
                }
                else {
                    showToast(0,t);
                }
            });
        };
        var deleteList = function() {
            $("#modal2").modal("hide");
            var activeList = $(".listContent.active")[0];
            if (activeList!=null){
                var lin = activeList.id.slice(5,activeList.id.length);
                $.post("deleteList.php",{name:getListName(lin)},function(t){
                    if (t=="success") {
                        showToast(7,"");
                        loadDB();
                    }
                    else {
                        showToast(0,t);
                    }
                })
            }
            else{
                return;
            }
        };
        var showToast = function(dd, wd) {
            $(".ts").hide();
            if (dd==0){
                $("#tsp").html(wd);
            }
            $("#ts"+dd).show();
            $("#addnewToast").toast("show");
        };
        $(function(){
            loadDB();
            //listGen();
            //loadAllLists();
            $("#addnewToast").toast({delay:4000});
            $("#addnew").click(function(){
                var wd = $("#fm-wd").val(),mn = $("#fm-mn").val(),ts = $("#fm-ts").val(),lt = $("#fm-lt").val();
                if (wd==""||(mn==""&&ts=="")||lt==""){
                    showToast(2,"");
                    return;
                }
                if (wd.length>limits.word||mn.length>limits.meaning||ts.length>limits.translation) {
                    showToast(0,limits.exceedMessage);
                    return;
                }
                lt = getListName(lt);
                //check same word
                for (var lf of db[lt]) {
                    if (lf[0]==wd) {
                        showToast(5,"");
                        return;
                    }
                }
                temp.optionSelected = $("#fm-lt").val();
                //check same word end
                $.post(baseURL+"addnew.php",{word:wd,meaning:mn,translation:ts,list:lt},function(t){
                    console.log(t);
                    var di = 0;
                    switch (t) {
                        case "success":
                            di = 1;
                            $("#fm-wd,#fm-mn,#fm-ts").val("");
                            $("#fm-wd").focus();
                            loadDB();
                            break;
                        case "missing":
                            di = 2;
                            break;
                        case "too many words":
                            di = 3;
                            break;
                        default:
                            di = 0;
                            break;
                    }
                    showToast(di,(di==0?t:""));
                })
            })
        })
    </script>
</head>

<body>
    <nav class="navbar navbar-dark fixed-top flex-md-nowrap bg-info shadow">
        <div class="container justify-content-start">
            <a class="navbar-brand" href="#">LVocab</a>
            <div class="navbar-text">Your Personal Vocabulary List</div>
        </div>
    </nav>
    <!-- <div class="space"></div> -->
    <div class="container-fluid">
        <div class="modal fade" id="modal1" tabindex="-1" role="dialog" aria-labelledby="newListModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newListModalLabel">New Vocabulary List</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="nl-name" class="col-form-label">Name:</label>
                                <input type="text" class="form-control" id="nl-name">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="createNewList()">Create List</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="modal2" tabindex="-1" role="dialog" aria-labelledby="modal2Label" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal2Label">Delete List</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete current list?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="deleteList()">Delete List</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="toast fade hide" id="addnewToast" style="position: absolute; top: 74px; right: 20px;     z-index: 5000;">
            <div class="toast-header">
                <strong class="mr-auto">Action Information</strong>
                <!-- <small>11 mins ago</small> -->
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body">
                <span class="ts text-success" id="ts1">Successfully added a new word.</span>
                <span class="ts text-danger" id="ts2">Missing fields. You need to enter a word and either/both of the meaning and translation.</span>
                <span class="ts text-danger" id="ts3">Oops, you have too many words in this list! Create a new list or use a different list.</span>
                <span class="ts text-success" id="ts4">Successfully deleted a word form list.</span>
                <span class="ts text-danger" id="ts5">Oops, looks like you already have this word in the list. If you want to update the meanings, delete the word from this list first.</span>
                <span class="ts text-success" id="ts6">Successfully created a new list.</span>
                <span class="ts text-success" id="ts7">List deleted.</span>
                <span class="ts text-danger" id="ts0">Error Info: <br /><span id="tsp"></span></span>
            </div>
        </div>
        <div class="row">
            <nav class="col-md-2 d-none d-md-block bg-light sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" id="v-pills-home-tab" data-toggle="pill" href="#v-pills-home" role="tab" aria-controls="v-pills-home" aria-selected="true">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="v-pills-list-tab" data-toggle="pill" href="#v-pills-list" role="tab" aria-controls="v-pills-list" aria-selected="false">Vocab Lists</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="v-pills-review-tab" data-toggle="pill" href="#v-pills-review" role="tab" aria-controls="v-pills-review" aria-selected="false">Review</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="v-pills-settings-tab" data-toggle="pill" href="#v-pills-settings" role="tab" aria-controls="v-pills-settings" aria-selected="false">Settings</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <main role="main" class="mainMain col-md-9 ml-sm-auto col-lg-10 px-4">
                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
                        <h4>LVocab - Home</h4>
                        <div class="space"></div>
                        <h5>Add New Vocabulary</h5>
                        <div class="form-group">
                            <label for="fm-lt">Vocab List</label>
                            <select class="form-control" id="fm-lt">
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fm-wd">Word</label>
                            <input type="text" class="form-control" id="fm-wd">
                        </div>
                        <div class="form-group">
                            <label for="fm-mn">Meaning</label>
                            <!-- <input type="text" class="form-control" id="fm-mn"> -->
                            <textarea class="form-control" id="fm-mn"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fm-ts">Translation ( Optional )</label>
                            <input type="text" class="form-control" id="fm-ts">
                        </div>
                        <button type="button" class="btn btn-primary" id="addnew">Add</button>
                    </div>
                    <div class="tab-pane fade" id="v-pills-list" role="tabpanel" aria-labelledby="v-pills-list-tab">
                        <h4 style="margin-left:20px;" class="d-flex justify-content-between align-items-center">
                            <span>My Vocabulary Lists</span>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" onclick="openModal(1)">Create New...</button>
                                <button type="button" class="btn btn-secondary" onclick="openModal(2)">Delete List</button>
                            </div>
                        </h4>
                        <div class="space"></div>
                        <div class="row">
                            <div class="col-3">
                                <div class="list-group" id="list-tab" role="tablist">
                                </div>
                            </div>
                            <div class="col-9">
                                <div class="tab-content" id="nav-tabContent">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-review" role="tabpanel" aria-labelledby="v-pills-review-tab">
                        <h4>Review</h4>
                        <div class="space"></div>
                        <p>Function still in development...</p>
                    </div>
                    <div class="tab-pane fade" id="v-pills-settings" role="tabpanel" aria-labelledby="v-pills-settings-tab">
                        <h4>Settings</h4>
                        <div class="space"></div>
                        <h5>Vocabulary Lists</h5>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupSelect01">Show Meaning</label>
                            </div>
                            <select class="custom-select" id="inputGroupSelect01">
                                <!-- <option selected>Choose...</option> -->
                                <option value="1" selected>Show All</option>
                                <option value="2">Show None</option>
                                <option value="3">Show Translation Only</option>
                                <option value="4">Show Meaning Only</option>
                            </select>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>

</html>